<!doctype html>
<html><!-- InstanceBegin template="/Templates/001.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
    <meta charset="utf-8">
    <!-- InstanceBeginEditable name="doctitle" -->
    <title>澄清页面</title>
    <link href="plugin/layer-animate/layer-animate.css" rel="stylesheet">
    <link href="plugin/naranja/naranja.min.css" rel="stylesheet">
    <!-- InstanceEndEditable -->
    <!-- InstanceBeginEditable name="head" -->
    <script src="/js/db-connection.js"></script>
    <style>
        .evaluation-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .progress-bar {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            margin-bottom: 20px;
        }
        .progress-step {
            display: flex;
            align-items: center;
            padding: 0 20px;
        }
        .progress-step.active {
            font-weight: bold;
            color: #2196F3;
        }
        .progress-arrow {
            margin: 0 10px;
            font-size: 20px;
        }
        .review-content {
            display: flex;
            flex: 1;
            gap: 20px;
        }
        .file-viewer {
            width: 600px;
            border: 1px solid #ddd;
            padding: 10px;
        }
        .pdf-container {
            height: 600px;
            border: 1px solid #eee;
            margin-bottom: 10px;
            overflow: auto;
        }
        .pdf-toolbar {
            display: flex;
            gap: 10px;
        }
        .pdf-toolbar button {
            padding: 5px 10px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .review-panel {
            flex: 1;
            border: 1px solid #ddd;
            padding: 20px;
        }
        .criteria-section {
            display: none;
        }
        .criteria-section.active {
            display: block;
        }
    </style>
    <!-- InstanceEndEditable -->
</head>

<body>
<!-- 不可编辑的顶部区域 -->
<div style="width:1040px; height:120px; background:#f0f0f0; position:relative; display:flex; justify-content:space-between; align-items:center; padding:0 50px;">
    <div style="font-size:28px; font-weight:bold;">中天阳光AI智能化评标系统</div>
    <div style="display:flex; gap:30px;">
        <a href="index.html" style="text-decoration:none; color:#333;">返回首页</a>
        <a href="login.html" style="text-decoration:none; color:#333;">登录</a>
        <a href="login-out.html" style="text-decoration:none; color:#333;">退出</a>
    </div>
</div>

<!-- 可编辑的主要内容区域 -->
<!-- InstanceBeginEditable name="content" -->
<div style="width:1040px; min-height:calc(100vh - 120px);">
    <div class="evaluation-container">
        <!-- 评审进度导航条 -->
        <div class="progress-bar" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h4 id="projectTitle" class="progress-step"></h4>
            <h4  id="step-qualification" class="progress-step"></h4>
        </div>

        <!-- 评审内容区域 -->
        <div class="review-content">
            <!-- 左侧文件展示区 -->
            <div class="file-viewer">
                <h3>评审界面</h3>
                <div style="margin-bottom: 15px;">
                    <label for="supplierSelect" style="margin-right: 10px;">选择专家:</label>
                    <select id="supplierSelect" style="padding: 5px; min-width: 200px;" onchange="switchSupplier(this.value)">
                        <option value="">-- 请选择专家 --</option>
                    </select>
                    <button type="button" onclick="refresh()" style="padding:5px 10px; background:#4CAF50; color:white; border:none; cursor:pointer;">刷新评审界面</button>
                </div>
                <div class="pdf-container" id="pdf-viewer" style="overflow: hidden;">
                    <p style="text-align:center;">请选择专家查看评审内容进度</p>
                    <iframe width='100%' height='100%' style="display: none;border-width:0px;" id="iframeInfo"></iframe>
                </div>
                <div class="pdf-toolbar">
                    <button onclick="zoomIn()">放大</button>
                    <button onclick="zoomOut()">缩小</button>
                    <button onclick="openInNewWindow()">弹出</button>
                </div>
            </div>

            <!-- 右侧评审标准区 -->
            <div class="review-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>澄清列表</h3>
                    <div>
                        <button onclick="refreshData()" style="padding:5px 10px; background:#4CAF50; color:white; border:none; cursor:pointer;">
                            刷新列表
                        </button>
                    </div>
                </div>
                <div id="project" style="margin-bottom:10px;" >
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                        <tr style="background:#f5f5f5;">
                            <th style="padding:10px; border:1px solid #ddd;width: 110px;">澄清原因</th>
                            <th style="padding:10px; border:1px solid #ddd;">响应截止时间</th>
                            <th style="padding:10px; border:1px solid #ddd;">操作</th>
                        </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 澄清弹窗 -->
<div id="announcementModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:100000;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; width:600px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>回复澄清</h3>
            <button onclick="closeModal()" style="padding:5px 10px; background:#f44336; color:white; border:none; cursor:pointer; font-size:20px;">×</button>
        </div>
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">回复内容<span style="color:red;">*</span></label>
            <textarea id="require" style="width:100%; height:150px; padding:8px; border:1px solid #ddd;box-sizing: border-box;"></textarea>
        </div>

        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px;">回复文件</label>
            <button onclick="showUploadDialog()" type="button" style="padding:8px 16px; background:#4CAF50; color:white; border:none; cursor:pointer; margin-top:10px;">上传文件</button>
            <div id="fileId">

            </div>
            <input data-file-id="" id="field" multiple type="file" style="width:100%; padding:8px; border:1px solid #ddd;display: none;">
        </div>

        <div style="text-align:center;">
            <button onclick="submit()" id="gonggao" style="padding:8px 20px; background:#4CAF50; color:white; border:none; cursor:pointer;">提交回复</button>
        </div>
    </div>
</div>

<script id="projectTemplate" type="text/x-handlebars-template">
    {{#if data}}
    {{#each data}}
    <tr style="border:1px solid #ddd;">
        {{#gt supplementaryContent.length 5 }}
            <td style="margin:10px;overflow: hidden;-webkit-line-clamp: 1;-webkit-box-orient: vertical;text-overflow: ellipsis;display: -webkit-box;">{{supplementaryContent}}</td>
        {{else}}
            <td style="padding:10px;">{{supplementaryContent}}</td>
        {{/gt}}
        <td style="padding:10px;">{{replyDate}}</td>
        <td style="padding:10px;">
            <button onclick="deail('{{id}}','{{#gtNowDate replyDate}}false{{else}}true{{/gtNowDate}}')" style="margin-top:5px;padding:5px 10px; color:white; border:none; cursor:pointer;{{#if replyContent}}background:#4CAF50;{{else}}{{#gtNowDate replyDate}}background:red;{{else}}background:#9ca1a5;{{/gtNowDate}}{{/if}}">{{#if replyContent}}查看{{else}}{{#gtNowDate replyDate}}回复{{else}}超时{{/gtNowDate}}{{/if}}</button>
        </td>
    </tr>
    {{/each}}
    {{else}}
        <tr>
            <td colspan="6" style="padding:10px; border:1px solid #ddd;">没有数据</td>
        </tr>
    {{/if}}
</script>
<script src="plugin/jquery-3.3.1.min.js" type="text/javascript"></script>
<script src="plugin/handlebars-v4.0.11-dist/handlebars-v4.0.11.min.js" type="text/javascript"></script>
<script src="plugin/handlebars-v4.0.11-dist/handlebars-ext.js" type="text/javascript"></script>
<script src="plugin/layer-animate/method.js" type="text/javascript"></script>
<script src="plugin/naranja/naranja.js" type="text/javascript"></script>
<script src="config/token.js" type="text/javascript"></script>
<script>
    verifyLogin();

    var urlAccountId = new URLSearchParams(window.location.search).get("id");
    var urlProjectId = new URLSearchParams(window.location.search).get("projectId");
    var urlIsExpert = new URLSearchParams(window.location.search).get("isExpert");
    var account;
    var dataInfo={};

    $(function() {
        initData();
        loadData();

        if(!urlIsExpert){
            $("#clarifyButton").show();
        }

        function initData(){
            $.ajax({
                url: "/account/get/" + urlAccountId,
                type: "GET",
                contentType: "application/json",
                success: function (e) {
                    if(e.status == 200){
                        account = e.data;
                        $("#step-qualification").html("供应商："+e.data.accountName);
                    }else{
                        alert(e.message);
                    }
                }
            });

            $.ajax({
                url: "/project/get/" + urlProjectId,
                type: "GET",
                contentType: "application/json",
                success: function (e) {
                    if(e.status == 200){
                        account = e.data;
                        $("#projectTitle").html("项目名称："+e.data.project.projectName)
                    }else{
                        alert(e.message);
                    }
                }
            });

            $.ajax({
                url: "/expertInfo/get/"+urlProjectId,
                type: "GET",
                contentType: "application/json",
                success:function(e) {
                    if(e.status == 200){
                        if(e.data.selectExpert.length>0){
                            for(var i=0;i<e.data.selectExpert.length;i++){
                                var selectExpert = e.data.selectExpert[i];
                                var id =selectExpert.member.id;
                                var name = selectExpert.member.name;

                                var option = document.createElement("option");
                                option.setAttribute("value",id);
                                option.innerText=name;
                                document.getElementById('supplierSelect').appendChild(option)
                            }
                        }
                    }else{
                        alert(e.message);
                    }
                }
            });
            responseInfo();

        }
    });

    function loadData(){
        var data = {"projectId":urlProjectId,"associationId":urlAccountId};
        $.ajax({
            url: "/tendereeInfo/list",
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            success:function(e) {
                if(e.status == 200){
                    $("#project tbody").html(Handlebars.compile($("#projectTemplate").html())(e));
                    if(e.data.length>0){
                        for(var i=0;i<e.data.length;i++){
                            dataInfo[e.data[i].id] = e.data[i];
                        }
                    }
                }else{
                    alert("查询失败："+e.message);
                }
            }
        });
    }

    var selectMemberId;
    // 切换供应商
    function switchSupplier(memberId) {
        selectMemberId = memberId;
        if(!memberId) return;
        getPrintContents(memberId,urlProjectId);
    }
    var scale = 0.5;
    var openPrintHTML;
    function getPrintContents(memberId,projectId){
        $("#iframeInfo").contents().find("body").html("");
        verifyLogin();
        $.ajax({
            url: "/resultReport/getPrintContents/"+memberId+"/"+projectId,
            type: "GET",
            contentType: "application/json",
            success:function(e) {
                if(!e.data){
                    e.data="";
                }
                $("#pdf-viewer>p").hide();
                openPrintHTML = printHTML(e.data);
                $("#iframeInfo").contents().find("body").html(openPrintHTML);
                $("#iframeInfo").contents().find("body>#contentInfo").attr("style","transform:scale("+scale+");transform-origin: 0% 0%;");
                $("#iframeInfo").show();
            }
        });
    }

    function refresh(){
        if(!selectMemberId){
            alert("请选择专家");
            return;
        }
        switchSupplier(selectMemberId);
    }

    // 放大
    function zoomIn() {
        scale += 0.25;
        $("#iframeInfo").contents().find("body>#contentInfo").attr("style","transform:scale("+scale+");transform-origin: 0% 0%;");
    }

    // 缩小
    function zoomOut() {
        if (scale > 0.25) {
            scale -= 0.25;
            $("#iframeInfo").contents().find("body>#contentInfo").attr("style","transform:scale("+scale+");transform-origin: 0% 0%;");
        }
    }
    //弹出
    function openInNewWindow(){
        if(!openPrintHTML){
            alert("请先选择专家！")
            return;
        }
        const printWindow = window.open('', '_blank');
        printWindow.document.write(openPrintHTML);
    }

    function printHTML(printContent){
        var content = `<html>
                    <head>
                        <title>已评审页面</title>
                        <style>
                        .evaluation-container {
                            display: flex;
                            flex-direction: column;
                        }
                        .progress-bar {
                            height: 80px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: #f5f5f5;
                            margin-bottom: 20px;
                        }
                        .progress-step {
                            display: flex;
                            align-items: center;
                            padding: 0 20px;
                        }
                        .progress-step.active {
                            font-weight: bold;
                            color: #2196F3;
                        }
                        .progress-arrow {
                            margin: 0 10px;
                            font-size: 20px;
                        }
                        .review-content {
                            display: flex;
                            flex: 1;
                            gap: 20px;
                        }
                        .file-viewer {
                            width: 600px;
                            border: 1px solid #ddd;
                            padding: 10px;
                        }
                        .pdf-container {
                            height: 600px;
                            border: 1px solid #eee;
                            margin-bottom: 10px;
                            overflow: auto;
                        }
                        .pdf-toolbar {
                            display: flex;
                            gap: 10px;
                        }
                        .pdf-toolbar button {
                            padding: 5px 10px;
                            background: #4CAF50;
                            color: white;
                            border: none;
                            cursor: pointer;
                        }
                        .review-panel {
                            flex: 1;
                            border: 1px solid #ddd;
                            padding: 20px;
                        }
                        .criteria-section ,.naranja-notification-box,#bidder_info{
                            display: none;
                        }
                        .criteria-section.active {
                            display: block;
                        }
                    </style>
                    </head>
                    <body>
                        <div id="readDiv" style="opacity: 0;z-index:9999;position: fixed;left:0;top:0;width:100%;height:100%;"></div>
                        <div id="contentInfo">
                            ${printContent}
                        </div>
                    </body>
                </html>`;
        return content;
    }

    // 显示弹窗
    function showModal() {
        $("#announcementModal").show();
    }

    function closeModal(){
        $("#announcementModal").hide();
    }

    function showUploadDialog() {
        document.getElementById('field').click();
    }

    $("body").on('change','#field', function () {
        if(this.files.length==0){
            return;
        }
        var fileId = uploadFile(this.files);
        $("#field").attr("data-file-id",fileId);

        var fileName = "";
        var fileIds = fileId.split(",");
        for(var i=0;i<this.files.length;i++){
            fileName+="<p><a style=\"padding:5px 10px; background:#2196F3; color:white; border:none; cursor:pointer; text-decoration:none;font-size: 13px;\" target=\"_blank\" href='/file/preview/"+fileIds[i]+"'>"+this.files[i].name+"（"+convertSize(this.files[i].size)+"）</a></p>";
        }
        $("#fileId").html(fileName);
    });
    var replyId;
    $("body").delegate(".layer-commit","click",function(){
        showModal();
    });
    $("body").delegate(".layer-cancel","click",function(){
        messageShow = true;
    });
    $("body").delegate(".layer-commit2","click",function(){
        var obj={
            type:"layer-fadeIn",
            title:"回复内容",
            content:dataInfo[replyId].replyContent
        };
        method.msg_layer(obj);
    });

    var replMessage;
    function deail(id,isTimeout){
        replyId = id;
        var btnInfo = ["关闭","回复澄清"];
        if(dataInfo[id].replyContent){
            replMessage = dataInfo[id].replyContent;
            btnInfo = ["关闭","0","查看回复"];
        }else{
            if(isTimeout == "true"){
                btnInfo = ["关闭"];
            }
        }

        var obj={
            type:"layer-fadeIn",
            title:"澄清说明",
            close:"false",
            content:dataInfo[id].content,
            btn:btnInfo
        };
        method.msg_layer(obj);
        if(!dataInfo[id].replyContent && isTimeout == "true"){
            setTimeout(function(){
                alert("已超时，无法回复澄清！")
            },500)
        }
    }

    function refreshData(){
        loadData();
        alert("刷新列表成功!")
    }

    var announcementModal = $("#announcementModal").html();
    function submit(){
        $("#gonggao").attr("disabled","true");
        var require = $("#require").val();
        var fileId = $("#field").attr("data-file-id");
        var content = "<table style='white-space: pre-wrap;font-family:Arial; font-size:15px; line-height:2;text-align: left;'>";
        content += "<tr><td style='text-align: right;font-weight: bolder;vertical-align: top;width: 180px;'>回复内容：</td><td style='text-align: left;width:76%;'><div style='max-height: 300px;overflow: auto;'>"+require+"<div></div></td></tr>";
        content += "<tr><td style='text-align: right;font-weight: bolder;vertical-align: top;width: 180px;'><p>回复文件：</p></td><td style='text-align: left;'><div style='max-height: 150px;overflow: auto;'>"+$("#fileId").html()+"</td></div></tr>";
        content += "</table>";

        if(!require) {
            alert("请填写带 * 字段为必填项！");
            $("#gonggao").removeAttr("disabled");
            return;
        }
        verifyLogin();
        var data = {"id":replyId,"replyContent":content,"tendereeInformField":fileId};
        $.ajax({
            url: "/tendereeInfo/update",
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            success:function(e) {
                if(e.status == 200){
                    loadData();
                    alert("提交回复成功！");
                    closeModal();
                    $("#announcementModal").html(announcementModal); // 清空数据
                    updateResponseInfo();
                    $(".layer-cancel").click();
                }else{
                    $("#gonggao").removeAttr("disabled");
                    alert("提交回复失败："+e.message);
                }
            }
        });
    }

    // 响应状态
    function updateResponseInfo(){
        $.ajax({
            url: "/resultReport/updateState/"+urlProjectId+"/"+urlAccountId+"/0",
            type: "GET",
            contentType: "application/json"
        });
    }

    // 响应状态
    function responseInfo(){
        $.ajax({
            url: "/resultReport/getState/"+new URLSearchParams(window.location.search).get("projectId"),
            type: "GET",
            contentType: "application/json",
            success:function(e) {
                if(e.status == 200){
                    var isShow = false;
                    var id ="";
                    Object.keys(e.data).forEach(key => {
                        var datas = key.split("|");
                        if(e.data[key] != "0" && e.data[key] != "1" && datas[1]==new URLSearchParams(window.location.search).get("id")){
                            isShow=true;
                            id = e.data[key];
                            return;
                        }
                    });
                    if(isShow){
                        if(messageShow){
                            narn('log','专家发起了澄清内容，请及时回复！',id);
                        }
                    }
                    setTimeout(responseInfo,10000);
                }
            }
        });
    }

    var messageShow = true;
    // 消息弹框
    function narn (type,message,id) {
        messageShow = false;
        naranja()[type]({
            title: '消息提示',
            isHideClose: true,
            text: message,
            timeout: 'keep',
            buttons: [{
                text: '查看',
                click: function (e) {
                    loadData();
                    e.closeNotification();
                    setTimeout(function(){
                        deail(id,'false');
                    },200);
                }
            },{
                text: '关闭',
                click: function (e) {
                    e.closeNotification();
                    messageShow = true;
                }
            }]
        })
    }


</script>
</body>
<!-- InstanceEnd --></html>
