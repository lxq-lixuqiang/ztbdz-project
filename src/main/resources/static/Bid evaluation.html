<!doctype html>
<html><!-- InstanceBegin template="/Templates/001.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
<meta charset="utf-8">
<!-- InstanceBeginEditable name="doctitle" -->
<title>专家评审页面</title>
<link href="plugin/layer-animate/layer-animate.css" rel="stylesheet">
<link href="plugin/naranja/naranja.min.css" rel="stylesheet">
<!-- InstanceEndEditable -->
<!-- InstanceBeginEditable name="head" -->
<script src="/js/db-connection.js"></script>
<!-- 引入PDF.js库 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
<style>
    .evaluation-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .progress-bar {
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f5f5f5;
        margin-bottom: 20px;
    }
    .progress-step {
        display: flex;
        align-items: center;
        padding: 0 20px;
    }
    .progress-step.active {
        font-weight: bold;
        color: #2196F3;
    }
    .progress-arrow {
        margin: 0 10px;
        font-size: 20px;
    }
    .review-content {
        display: flex;
        flex: 1;
        gap: 20px;
    }
    .file-viewer {
        width: 600px;
        border: 1px solid #ddd;
        padding: 10px;
    }
    .pdf-container {
        height: 600px;
        border: 1px solid #eee;
        margin-bottom: 10px;
        overflow: auto;
    }
    .pdf-toolbar {
        display: flex;
        gap: 10px;
    }
    .pdf-toolbar button {
        padding: 5px 10px;
        background: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
    }
    .review-panel {
        flex: 1;
        border: 1px solid #ddd;
        padding: 20px;
    }
    .criteria-section {
        display: none;
    }
    .criteria-section.active {
        display: block;
    }
</style>
<script>
    // 切换评审阶段
    function setReviewStage(stage) {
        console.log('切换评审阶段:', stage);
        
        // 更新进度条
        document.querySelectorAll('.progress-step').forEach(step => {
            step.classList.remove('active');
        });
        document.getElementById(`step-${stage}`).classList.add('active');
        
        // 更新评审标准
        document.querySelectorAll('.criteria-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(`criteria-${stage}`).classList.add('active');
        
        // 特殊处理不同评审阶段
        switch(stage) {
            case 'compliance':
                console.log('初始化符合性评审');
                setTimeout(generateComplianceSuppliers, 100); // 延迟确保DOM更新
                break;
            case 'scoring':
                initScoringPage();
                break;
        }
        if(stage=='result'){
            printContents[3] =$("body").html();
            savePrintContent();
        }
    }
    
    // PDF查看器相关变量
    let pdfDoc = null,
        pageNum = 1,
        pageRendering = false,
        pageNumPending = null,
        scale = 1.0,
        canvas = null,
        ctx = null;
    
    // 初始化PDF查看器
    function initPDFViewer(fileId) {
        const pdfContainer = document.getElementById('pdf-viewer');
        
        // 显示加载状态
        pdfContainer.innerHTML = '<p style="text-align:center;">正在加载PDF文件...</p>';
        if(!fileId){
            pdfContainer.innerHTML = '<p style="text-align:center;">供应商未上传投标文件</p>';
            return;
        }else if(fileId==-1){
            pdfContainer.innerHTML = '<p style="text-align:center;">请选择供应商查看投标文件并点击文件查看内容</p>';
            return;
        }

        // 创建Canvas元素
        canvas = document.createElement('canvas');
        canvas.style.display = 'block';
        canvas.style.margin = '0 auto';
        ctx = canvas.getContext('2d');

        $("#pdf-viewer").attr("data-fileId",fileId);
        // 处理PDF文件路径
        let pdfPath;
        if (window.location.protocol === 'file:') {
            // 本地文件系统路径处理
            const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
            pdfPath = basePath + "/file/preview/"+fileId;
            console.log('本地文件模式，PDF路径:', pdfPath);
        } else {
            // 服务器路径处理
            pdfPath = "/file/preview/"+fileId;
            console.log('服务器模式，PDF路径:', pdfPath);
        }
        
        // 添加PDF.js配置
        const loadingTask = pdfjsLib.getDocument({
            url: pdfPath,
            disableAutoFetch: true,
            disableStream: true,
            withCredentials: true
        });
        
        loadingTask.promise.then(function(pdf) {
            pdfDoc = pdf;
                pdfContainer.innerHTML = '';                pdfContainer.appendChild(canvas);
                renderPage(1);
            },
            function(error) {
                // 显示错误信息
                pdfContainer.innerHTML = `
                    <div style="color:red; text-align:center;">
                        <p>无法加载PDF文件</p>
                        <p>错误原因: ${error.message}</p>
                        <p>请确保test.pdf文件存在于项目根目录(d:\AIcode\AI评标系统\)</p>
                        <p>当前运行模式: ${window.location.protocol === 'file:' ? '本地文件' : '服务器'}</p>
                        <p>建议解决方案:</p>
                        <ol>
                            <li>使用VS Code的Live Server插件运行项目</li>
                            <li>或使用http服务器而非直接打开HTML文件</li>
                            <li>检查浏览器控制台获取详细错误信息</li>
                        </ol>
                    </div>
                `;
                console.error('PDF加载错误:', error);
            }
        );
    }
    
    // 渲染PDF页面
    function renderPage(num) {
        pageRendering = true;
        pdfDoc.getPage(num).then(function(page) {
            const viewport = page.getViewport({scale: scale});
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            
            const renderTask = page.render(renderContext);
            renderTask.promise.then(function() {
                pageRendering = false;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
        });
    }
    
    // 放大
    function zoomIn() {
        scale += 0.25;
        renderPage(pageNum);
    }
    
    // 缩小
    function zoomOut() {
        if (scale > 0.25) {
            scale -= 0.25;
            renderPage(pageNum);
        }
    }
    
    // 弹出窗口查看
    function openInNewWindow() {
        const pdfPath = window.location.protocol === 'file:' 
            ? new URL("/file/preview/"+$("#pdf-viewer").attr("data-fileId"), window.location.href).href
            : "/file/preview/"+$("#pdf-viewer").attr("data-fileId");
        console.log('弹出窗口PDF路径:', pdfPath);
        window.open(pdfPath, '_blank');
    }

    var printContents = ["","","",""];
    // 打印页面
    function print(){
        if(printContents[0].length === 0) {
            alert('请先提交评审');
            return;
        }
        var printContent = getPrintContent();

        // 创建打印专用窗口
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printHTML(printContent));
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
    }

    function getPrintContent(){
        var printContent = "";
        for(var i=0;i<printContents.length;i++){
            printContent+="<div style='margin-bottom:20px;'>"+printContents[i]+"</div>";
        }
        return printContent;
    }

    function savePrintContent(){
        var data = {"project":{"id":new URLSearchParams(window.location.search).get("id")},"member":{"id":getMember().id},"resultHtml":getPrintContent()};
        $.ajax({
            url: "/resultReport/savePrintContents",
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            success:function(e) {}
        });
    }

    function printHTML(printContent){
        var content = `<html>
                    <head>
                        <title>评审页面</title>
                       <style>
                        .evaluation-container {
                            display: flex;
                            flex-direction: column;
                            height: 100%;
                        }
                        .progress-bar {
                            height: 80px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: #f5f5f5;
                            margin-bottom: 20px;
                        }
                        .progress-step {
                            display: flex;
                            align-items: center;
                            padding: 0 20px;
                        }
                        .progress-step.active {
                            font-weight: bold;
                            color: #2196F3;
                        }
                        .progress-arrow {
                            margin: 0 10px;
                            font-size: 20px;
                        }
                        .review-content {
                            display: flex;
                            flex: 1;
                            gap: 20px;
                        }
                        .file-viewer {
                            width: 600px;
                            border: 1px solid #ddd;
                            padding: 10px;
                        }
                        .pdf-container {
                            height: 600px;
                            border: 1px solid #eee;
                            margin-bottom: 10px;
                            overflow: auto;
                        }
                        .pdf-toolbar {
                            display: flex;
                            gap: 10px;
                        }
                        .pdf-toolbar button {
                            padding: 5px 10px;
                            background: #4CAF50;
                            color: white;
                            border: none;
                            cursor: pointer;
                        }
                        .review-panel {
                            flex: 1;
                            border: 1px solid #ddd;
                            padding: 20px;
                        }
                        .criteria-section {
                            display: none;
                        }
                        .criteria-section.active {
                            display: block;
                        }
                    </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                </html>`;
        return content;
    }
    
    // 切换废标按钮状态
    function toggleDisqualify() {
        const enough = document.getElementById('enoughSuppliers');
        const notEnough = document.getElementById('notEnoughSuppliers');
        const disqualifyBtn = document.getElementById('disqualifyBtn');
        
        // 互斥选择
        if (enough.checked) {
            notEnough.checked = false;
            disqualifyBtn.disabled = true;
            disqualifyBtn.style.opacity = '0.6';
            disqualifyBtn.style.cursor = 'not-allowed';
        } else if (notEnough.checked) {
            enough.checked = false;
            disqualifyBtn.disabled = false;
            disqualifyBtn.style.opacity = '1';
            disqualifyBtn.style.cursor = 'pointer';
        }
    }

    // 废标操作
    function disqualifyProject() {
        if (confirm('确定要废标吗？此操作不可撤销！')) {
            location.href ='bid-invalid.html?id='+new URLSearchParams(window.location.search).get("id");
        }
    }

    // 设置所有供应商资格评审状态
    function setAllQualification(status) {
        const form = document.getElementById('supplierEvaluationForm');
        const radios = form.querySelectorAll('input[type="radio"]');
        
        radios.forEach(radio => {
            if (radio.value === status) {
                radio.checked = true;
            }
        });
        
        // 自动勾选"够3家"如果全部通过
        if (status === 'pass') {
            document.getElementById('enoughSuppliers').checked = true;
            document.getElementById('notEnoughSuppliers').checked = false;
            document.getElementById('disqualifyBtn').disabled = true;
        }
    }

    // 提交资格评审
    function submitQualificationReview() {
        const form = document.getElementById('supplierEvaluationForm');
        const enoughSuppliers = document.getElementById('enoughSuppliers').checked;
        const notEnoughSuppliers = document.getElementById('notEnoughSuppliers').checked;
        
        // 统计通过评审的供应商数量
        let passedCount = 0;
        const radios = form.querySelectorAll('input[type="radio"]:checked');
        radios.forEach(radio => {
            if (radio.value === 'pass') {
                passedCount++;
            }
        });
        
        // 检查供应商数量
        if (notEnoughSuppliers) {
            if (!confirm('确认不足3家供应商通过资格评审，是否继续废标？')) {
                return;
            }
            disqualifyProject();
            return;
        }
        
        if (!enoughSuppliers || passedCount < 3) {
            alert('通过资格评审的供应商不足3家，请重新评审或选择"不足3家"进行废标！');
            return;
        }

        $("#enoughSuppliers").attr("checked","checked");
        var e = JSON.parse(localStorage.getItem('data'+getMember().id));
        // 保存评审数据
        var saveDataList = [];
        var projectId = new URLSearchParams(window.location.search).get("id");
        for(var i=0;i<e.data.length;i++){
            var data = e.data[i];
            var isPass = $("input[name='supplier"+data.id+"']:checked").val()=='pass'?0:1;
            var reviewDescription = $("textarea[name='supplier1_comment"+data.id+"']").val();

            $("textarea[name='supplier1_comment"+data.id+"']").text(reviewDescription);
            $("input[name='supplier"+data.id+"']:checked").attr("checked","checked");

            var saveData={"sort":i+1,"evaluationCriteriaName":"资格评审标准","reviewType":"1","isPass":isPass,"reviewDescription":reviewDescription,"projectId":projectId,"projectRegisterId":data.id};
            saveDataList.push(saveData);
        }
        printContents[0] =$("body").html();
        savePrintContent();
        $.ajax({
            url: "/evaluation/create",
            type: "POST",
            data: JSON.stringify(saveDataList),
            contentType: "application/json",
            success:function(e) {
                if(e.status != 200){
                    alert("资格评审提交失败："+e.message);
                }
            }
        });

        
        // 跳转到符合（实质性）标签页
        setReviewStage('compliance');
        alert(`资格评审已提交，${passedCount}家供应商通过评审，请继续实质性符合评审！`);
    }

    // 切换符合性评审废标按钮状态
    function toggleComplianceDisqualify() {
        const enough = document.getElementById('enoughCompliantSuppliers');
        const notEnough = document.getElementById('notEnoughCompliantSuppliers');
        const disqualifyBtn = document.getElementById('complianceDisqualifyBtn');
        
        // 互斥选择
        if (enough.checked) {
            notEnough.checked = false;
            disqualifyBtn.disabled = true;
            disqualifyBtn.style.opacity = '0.6';
            disqualifyBtn.style.cursor = 'not-allowed';
        } else if (notEnough.checked) {
            enough.checked = false;
            disqualifyBtn.disabled = false;
            disqualifyBtn.style.opacity = '1';
            disqualifyBtn.style.cursor = 'pointer';
        }
    }

    // 设置所有供应商符合性评审状态
    function setAllCompliance(status) {
        const form = document.getElementById('complianceEvaluationForm');
        const radios = form.querySelectorAll('input[type="radio"]');
        
        radios.forEach(radio => {
            if (radio.value === status) {
                radio.checked = true;
            }
        });
        
        // 自动勾选"够3家"如果全部通过
        if (status === 'pass') {
            document.getElementById('enoughCompliantSuppliers').checked = true;
            document.getElementById('notEnoughCompliantSuppliers').checked = false;
            document.getElementById('complianceDisqualifyBtn').disabled = true;
        }
    }

    var notPass = [];
    // 提交实质性符合评审
    function submitComplianceReview() {
        const form = document.getElementById('complianceEvaluationForm');
        const enoughCompliantSuppliers = document.getElementById('enoughCompliantSuppliers').checked;
        const notEnoughCompliantSuppliers = document.getElementById('notEnoughCompliantSuppliers').checked;
        
        // 验证表单 - 只检查显示的供应商
        let valid = true;
        let passedCount = 0;
        const supplierDivs = document.querySelectorAll('#complianceSuppliersList > div');
        
        supplierDivs.forEach(div => {
            const id = div.querySelector('.supplier-name').dataset.id;
            const radio = form.querySelector(`input[name="supplier${id}_compliance"]:checked`);
            
            if (!radio) {
                valid = false;
                return;
            }
            
            if (radio.value === 'pass') {
                passedCount++;
            }
        });
        
        if (!valid) {
            alert('请为所有显示的供应商选择通过或不通过！');
            return;
        }
        
        // 检查供应商数量
        if (notEnoughCompliantSuppliers) {
            if (!confirm('确认不足3家供应商通过实质性符合评审，是否继续废标？')) {
                return;
            }
            disqualifyProject();
            return;
        }
        
        if (!enoughCompliantSuppliers || passedCount < 3) {
            alert('通过实质性符合评审的供应商不足3家，请重新评审或选择"不足3家"进行废标！');
            return;
        }

        $("#enoughCompliantSuppliers").attr("checked","checked");
        // 保存评审数据
        var e = JSON.parse(localStorage.getItem('data'+getMember().id));
        var saveDataList = [];
        var projectId = new URLSearchParams(window.location.search).get("id");
        for(var i=0;i<e.data.length;i++){
            var data = e.data[i];
            var isPass = $("input[name='supplier"+data.id+"_compliance']:checked").val()=='pass'?0:1;
            var reviewDescription = $("textarea[name='supplier"+data.id+"_compliance_comment']").val();

            $("textarea[name='supplier"+data.id+"_compliance_comment']").text(reviewDescription);
            $("input[name='supplier"+data.id+"_compliance']:checked").attr("checked","checked");

            if($("input[name='supplier"+data.id+"_compliance']")){
                var saveData={"sort":i+1,"evaluationCriteriaName":"实质性符合标准","reviewType":"2","isPass":isPass,"reviewDescription":reviewDescription,"projectId":projectId,"projectRegisterId":data.id};
                if(isPass == 1){
                    notPass.push({"sort":1,"evaluationCriteriaName":"价格分","score":0,"reviewDescription":reviewDescription,"reviewType":"3","projectId":projectId,"projectRegisterId":data.id});
                    notPass.push({"sort":2,"evaluationCriteriaName":"技术参数分","score":0,"reviewDescription":reviewDescription,"reviewType":"3","projectId":projectId,"projectRegisterId":data.id});
                    notPass.push({"sort":3,"evaluationCriteriaName":"业绩分","score":0,"reviewDescription":reviewDescription,"reviewType":"3","projectId":projectId,"projectRegisterId":data.id});
                    notPass.push({"sort":4,"evaluationCriteriaName":"方案分","score":0,"reviewDescription":reviewDescription,"reviewType":"3","projectId":projectId,"projectRegisterId":data.id});
                }
                saveDataList.push(saveData);
            }
        }

        printContents[1] =$("body").html();
        savePrintContent();
        $.ajax({
            url: "/evaluation/create",
            type: "POST",
            data: JSON.stringify(saveDataList),
            contentType: "application/json",
            success:function(e) {
                if(e.status != 200){
                    alert("资格评审提交失败："+e.message);
                }
            },error: function (e) {
                alert("资格评审提交失败：" +e.message );
            }
        });
        
        // 跳转到评分标签页并初始化
        setReviewStage('scoring');
        initScoringPage();
        alert(`实质性符合评审已提交，${passedCount}家供应商通过评审，请继续评分！`);
    }

    // 计算分数并显示在汇总表
    function calculateScores() {
        const form = document.getElementById('scoringForm');
        let hasEmptyFields = false;
        let allSuppliersFilled = true;
        
        // 获取所有通过评审的供应商
        const passedSuppliers = [];
        document.querySelectorAll('#complianceSuppliersList .supplier-name').forEach(supplierEl => {
            passedSuppliers.push({
                id: supplierEl.dataset.id,
                name: supplierEl.dataset.name
            });
        });

        var isError = false;
        // 计算并更新汇总显示
        passedSuppliers.forEach(supplier => {
            const name = supplier.name;
            const priceInput = form.querySelector(`input[name="supplier${supplier.id}_price"]`);
            const techInput = form.querySelector(`input[name="supplier${supplier.id}_tech"]`);
            const performanceInput = form.querySelector(`input[name="supplier${supplier.id}_performance"]`);
            const solutionInput = form.querySelector(`input[name="supplier${supplier.id}_solution"]`);
            
            const price = priceInput ? parseInt(priceInput.value) : NaN;
            const tech = techInput ? parseInt(techInput.value) : NaN;
            const performance = performanceInput ? parseInt(performanceInput.value) : NaN;
            const solution = solutionInput ? parseInt(solutionInput.value) : NaN;
            
            // 检查是否有未填项
            if (isNaN(price) || isNaN(tech) || isNaN(performance) || isNaN(solution)) {
                hasEmptyFields = true;
                if (priceInput || techInput || performanceInput || solutionInput) {
                    allSuppliersFilled = false;
                }
            }
            
            const total = (isNaN(price) ? 0 : price) + 
                         (isNaN(tech) ? 0 : tech) + 
                         (isNaN(performance) ? 0 : performance) + 
                         (isNaN(solution) ? 0 : solution);
            if(isError){
                return;
            }
            if(total>100){
                alert("【"+name+"】供应商合计分数："+total+"，总分不能超过100分，请重新修改分数！");
                isError = true;
                return;
            }


            // 更新汇总显示
            if(document.getElementById(`supplier${supplier.id}_price_summary`)) document.getElementById(`supplier${supplier.id}_price_summary`).textContent = isNaN(price) ? '-' : price;
            if(document.getElementById(`supplier${supplier.id}_tech_summary`)) document.getElementById(`supplier${supplier.id}_tech_summary`).textContent = isNaN(tech) ? '-' : tech;
            if(document.getElementById(`supplier${supplier.id}_performance_summary`)) document.getElementById(`supplier${supplier.id}_performance_summary`).textContent = isNaN(performance) ? '-' : performance;
            if(document.getElementById(`supplier${supplier.id}_solution_summary`)) document.getElementById(`supplier${supplier.id}_solution_summary`).textContent = isNaN(solution) ? '-' : solution;
            if(document.getElementById(`supplier${supplier.id}_total_summary`)) document.getElementById(`supplier${supplier.id}_total_summary`).textContent = total === 0 ? '-' : total;
        });
        if(isError){
            return;
        }
        
        if (hasEmptyFields) {
            if (!allSuppliersFilled) {
                alert('部分供应商的评分项未填写完整，请检查后重新提交分数！');
            } else {
                alert('分数已计算并显示在汇总表中，请确认后提交！');
            }
        } else {
            alert('分数已计算并显示在汇总表中，请确认后提交！');
        }
    }

    // 动态生成评分表和汇总表
    function generateScoringForm() {
        const container = document.getElementById('qualifiedSuppliersScoring');
        const summaryTable = document.querySelector('#scoreSummaryTable tbody');
        container.innerHTML = '';
        summaryTable.innerHTML = '';
        
        // 获取资格和符合性都通过的供应商
        const passedSuppliers = [];
        document.querySelectorAll('#complianceSuppliersList .supplier-name').forEach(supplierEl => {
            const id = supplierEl.dataset.id;
            
            // 检查资格评审是否通过
            const qualificationRadio = document.querySelector(`input[name="supplier${id}"]:checked`);
            if (!qualificationRadio || qualificationRadio.value !== 'pass') return;
            
            // 检查符合性评审是否通过
            const complianceRadio = document.querySelector(`input[name="supplier${id}_compliance"]:checked`);
            if (complianceRadio && complianceRadio.value === 'pass') {
                passedSuppliers.push({
                    id: id,
                    name: supplierEl.dataset.name
                });
            }
        });
        
        // 为每个通过评审的供应商生成评分表和汇总行
        passedSuppliers.forEach(supplier => {
            // 生成评分表单
            const supplierDiv = document.createElement('div');
            supplierDiv.style.marginBottom = '30px';
            supplierDiv.style.border = '1px solid #eee';
            supplierDiv.style.borderRadius = '4px';
            supplierDiv.style.padding = '15px';
            
            supplierDiv.innerHTML = `
                <h4>${supplier.name}</h4>
                <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">评分项</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">评分(0-100)</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">扣分理由</th>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">价格分</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">
                            <input type="number" name="supplier${supplier.id}_price" min="0" max="100" style="width:80px;" required>
                        </td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">
                            <input type="text" name="supplier${supplier.id}_price_reason" style="width:100%; padding:5px;box-sizing:border-box;">
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">技术参数分</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">
                            <input type="number" name="supplier${supplier.id}_tech" min="0" max="100" style="width:80px;" required>
                        </td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">
                            <input type="text" name="supplier${supplier.id}_tech_reason" style="width:100%; padding:5px;box-sizing:border-box;">
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">业绩分</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">
                            <input type="number" name="supplier${supplier.id}_performance" min="0" max="100" style="width:80px;" required>
                        </td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">
                            <input type="text" name="supplier${supplier.id}_performance_reason" style="width:100%; padding:5px;box-sizing:border-box;">
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">方案分</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">
                            <input type="number" name="supplier${supplier.id}_solution" min="0" max="100" style="width:80px;" required>
                        </td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">
                            <input type="text" name="supplier${supplier.id}_solution_reason" style="width:100%; padding:5px;box-sizing:border-box;">
                        </td>
                    </tr>
                </table>
            `;
            
            container.appendChild(supplierDiv);
            
            // 生成汇总行
            const summaryRow = document.createElement('tr');
            summaryRow.innerHTML = `
                <td style="padding:8px; border-bottom:1px solid #ddd;">${supplier.name}</td>
                <td id="supplier${supplier.id}_price_summary" style="padding:8px; border-bottom:1px solid #ddd;">-</td>
                <td id="supplier${supplier.id}_tech_summary" style="padding:8px; border-bottom:1px solid #ddd;">-</td>
                <td id="supplier${supplier.id}_performance_summary" style="padding:8px; border-bottom:1px solid #ddd;">-</td>
                <td id="supplier${supplier.id}_solution_summary" style="padding:8px; border-bottom:1px solid #ddd;">-</td>
                <td id="supplier${supplier.id}_total_summary" style="padding:8px; border-bottom:1px solid #ddd;">-</td>
            `;
            summaryTable.appendChild(summaryRow);
        });
    }

    // 提交评分
    function submitScoring() {
        const form = document.getElementById('scoringForm');
        const inputs = form.querySelectorAll('input[type="number"]:required');
        
        // 验证所有评分项已填写
        let valid = true;
        inputs.forEach(input => {
            if (input.value === '') {
                valid = false;
                return;
            }
        });
        
        if (!valid) {
            alert('请为所有供应商的评分项填写分数！');
            return;
        }


        var isError = false;
        var bidInfo = {};
        // 保存评审数据
        var saveDataList = [];
        if(notPass.length>0){
            saveDataList = notPass;
        }
        var projectId = new URLSearchParams(window.location.search).get("id");
        // 收集所有供应商评分数据
        const scores = [];
        document.querySelectorAll('#complianceSuppliersList .supplier-name').forEach(supplierEl => {
            const id = supplierEl.dataset.id;
            const name = supplierEl.dataset.name;
            const price = form.querySelector(`input[name="supplier${id}_price"]`)? parseInt(form.querySelector(`input[name="supplier${id}_price"]`).value) : 0;
            const tech = form.querySelector(`input[name="supplier${id}_tech"]`)? parseInt(form.querySelector(`input[name="supplier${id}_tech"]`).value) : 0;
            const performance = form.querySelector(`input[name="supplier${id}_performance"]`)? parseInt(form.querySelector(`input[name="supplier${id}_performance"]`).value) : 0;
            const solution = form.querySelector(`input[name="supplier${id}_solution"]`)? parseInt(form.querySelector(`input[name="supplier${id}_solution"]`).value) : 0;
            $(`input[name="supplier${id}_price"]`).attr("value",price);
            $(`input[name="supplier${id}_tech"]`).attr("value",tech);
            $(`input[name="supplier${id}_performance"]`).attr("value",performance);
            $(`input[name="supplier${id}_solution"]`).attr("value",solution);

            if(isError){
                return;
            }
            var total = price + tech + performance + solution;
            if(!bidInfo.total){
                bidInfo={"total":total,"id":id,"name":name};
            }else if(total>bidInfo.total){
                bidInfo={"total":total,"id":id,"name":name};
            }
            if(total>100){
                alert("【"+name+"】供应商合计分数："+total+"，总分不能超过100分，请重新修改分数！");
                isError = true;
                return;
            }

            const priceReason = form.querySelector(`input[name="supplier${id}_price_reason"]`)? form.querySelector(`input[name="supplier${id}_price_reason"]`).value : 0;
            const techReason = form.querySelector(`input[name="supplier${id}_tech_reason"]`)? form.querySelector(`input[name="supplier${id}_tech_reason"]`).value : 0;
            const performanceReason = form.querySelector(`input[name="supplier${id}_performance_reason"]`)? form.querySelector(`input[name="supplier${id}_performance_reason"]`).value : 0;
            const solutionReason = form.querySelector(`input[name="supplier${id}_solution_reason"]`)? form.querySelector(`input[name="supplier${id}_solution_reason"]`).value : 0;
            $(`input[name="supplier${id}_price_reason"]`).attr("value",priceReason);
            $(`input[name="supplier${id}_tech_reason"]`).attr("value",techReason);
            $(`input[name="supplier${id}_performance_reason"]`).attr("value",performanceReason);
            $(`input[name="supplier${id}_solution_reason"]`).attr("value",solutionReason);

            saveDataList.push({"sort":1,"evaluationCriteriaName":"价格分","score":price,"deductionReason":priceReason,"reviewType":"3","projectId":projectId,"projectRegisterId":id});
            saveDataList.push({"sort":2,"evaluationCriteriaName":"技术参数分","score":tech,"deductionReason":techReason,"reviewType":"3","projectId":projectId,"projectRegisterId":id});
            saveDataList.push({"sort":3,"evaluationCriteriaName":"业绩分","score":performance,"deductionReason":performanceReason,"reviewType":"3","projectId":projectId,"projectRegisterId":id});
            saveDataList.push({"sort":4,"evaluationCriteriaName":"方案分","score":solution,"deductionReason":solutionReason,"reviewType":"3","projectId":projectId,"projectRegisterId":id});

            scores.push({
                id: id,
                name: name,
                price: price,
                tech: tech,
                performance: performance,
                solution: solution,
                total: price + tech + performance + solution
            });

        });
        if(isError){
            return;
        }
        localStorage.setItem('bidInfo', JSON.stringify(bidInfo)); // 中标信息

        calculateScores();
        printContents[2] =$("body").html();
        $.ajax({
            url: "/evaluation/create",
            type: "POST",
            data: JSON.stringify(saveDataList),
            contentType: "application/json",
            success:function(e) {
                if(e.status != 200){
                    alert("资格评审提交失败："+e.message);
                }else{
                    if(notPass.length>0){
                        notPass = [];
                    }
                }
            }
        });
        $("#resultInfo").html($("#resultScore").html());
        var bidInfo = JSON.parse(localStorage.getItem('bidInfo')); // 中标信息



        // 保存评分数据到本地存储
        localStorage.setItem('evaluationScores', JSON.stringify(scores));
        
        // 跳转到评审结果页
        setReviewStage('result');
        alert('所有供应商评分已成功提交！');
    }

    // 初始化评分页时生成表单
    function initScoringPage() {
        generateScoringForm();
    }

    // 模拟供应商文件数据
    var supplierFiles = {};

    // 切换供应商
    function switchSupplier(supplierId) {
        if (!supplierId) return;
        
        const fileList = supplierFiles[supplierId];
        const bidderInfo = document.getElementById('bidder_info');
        
        bidderInfo.innerHTML = `
            <div style="margin-bottom: 10px;">
                <strong>当前供应商文件:</strong>
                <div style="margin-top: 5px;padding-left:40px;">
                    ${fileList.map(file => `<div><button style="margin-top:5px;padding:5px 10px; background:#2196F3; color:white; border:none; cursor:pointer; text-decoration:none;font-size: 13px;" onclick='initPDFViewer("${file.split("）_")[1]}")'>${file.split("）_")[0]+"）"}</button></div>`).join('')}
                </div>
            </div>
        `;
        
        // 这里可以添加实际加载第一个文件的逻辑
        if(fileList.length==0){
            initPDFViewer('');
        }else{
            initPDFViewer(fileList[0].split("）_")[1]);
        }
    }

    // 切换供应商
    function changeSelect(accountId) {
        localStorage.setItem('data',accountId);
        localStorage.setItem('page',1);
        clarifyData(accountId);
    }

    // 页面加载时初始化
    window.onload = function() {
        // 先设置PDF.js worker路径
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';
        
        // 初始化评审界面
        setReviewStage('qualification');

        // 最后初始化PDF查看器
        // initPDFViewer();
    };
</script>
<!-- InstanceEndEditable -->
</head>

<body>
    <!-- 不可编辑的顶部区域 -->
    <div style="width:1040px; height:120px; background:#f0f0f0; position:relative; display:flex; justify-content:space-between; align-items:center; padding:0 50px;">
        <div style="font-size:28px; font-weight:bold;">中天阳光AI智能化评标系统</div>
        <div style="display:flex; gap:30px;">
            <a href="index.html" style="text-decoration:none; color:#333;">返回首页</a>
            <a href="login.html" style="text-decoration:none; color:#333;">登录</a>
            <a href="login-out.html" style="text-decoration:none; color:#333;">退出</a>
        </div>
    </div>
    
    <!-- 可编辑的主要内容区域 -->
    <!-- InstanceBeginEditable name="content" -->
    <div style="width:1040px; min-height:calc(100vh - 120px);">
        <div class="evaluation-container">
            <!-- 评审进度导航条 -->
            <div class="progress-bar">
                <div id="step-qualification" class="progress-step active" onclick="setReviewStage('qualification')">资格</div>
                <div class="progress-arrow">→</div>
                <div id="step-compliance" class="progress-step" onclick="setReviewStage('compliance')">符合性</div>
                <div class="progress-arrow">→</div>
                <div id="step-scoring" class="progress-step" onclick="setReviewStage('scoring')">评分</div>
                <div class="progress-arrow">→</div>
                <div id="step-result" class="progress-step" onclick="setReviewStage('result')">评审结果</div>
            </div>
            
            <!-- 评审内容区域 -->
            <div class="review-content">
                <!-- 左侧文件展示区 -->
                <div class="file-viewer">
                    <h3>评审文件</h3>
                    <div style="margin-bottom: 15px;">
                        <label for="supplierSelect" style="margin-right: 10px;">选择供应商:</label>
                        <select id="supplierSelect" style="padding: 5px; min-width: 200px;" onchange="switchSupplier(this.value)">
                            <option value="">-- 请选择供应商 --</option>
                        </select>
                    </div>
                    <div id="bidder_info"></div>
                    <div class="pdf-container" id="pdf-viewer">
                        <!-- PDF内容将通过canvas渲染 -->
                    </div>
                    <div class="pdf-toolbar">
                        <button onclick="zoomIn()">放大</button>
                        <button onclick="zoomOut()">缩小</button>
                        <button onclick="openInNewWindow()">弹出</button>
                        <button onclick="print()">打印</button>
                    </div>
                </div>
                
                <!-- 右侧评审标准区 -->
                <div class="review-panel">
                    <div id="criteria-qualification" class="criteria-section active">
                        <h3>资格评审标准</h3>
                        <p>符合政府采购二十二条规定：</p>
                        <ul>
                            <li>1. 具有独立承担民事责任的能力</li>
                            <li>2. 具有良好的商业信誉和健全的财务会计制度</li>
                            <li>3. 具有履行合同所必需的设备和专业技术能力</li>
                            <!-- 其他条款... -->
                        </ul>
                        
                        <div style="margin-top:30px;">
                            <h4>供应商资格评审</h4>
                            <form id="supplierEvaluationForm">
                                <div id="gys">

                                </div>

                                <!-- 是否够3家 -->
                                <div style="margin:20px 0; padding:15px; background:#f9f9f9; border-radius:4px;">
                                    <label style="display:block; margin-bottom:10px;">
                                        <input type="checkbox" id="enoughSuppliers" onchange="toggleDisqualify()"> 本项目够3家
                                    </label>
                                    <label>
                                        <input type="checkbox" id="notEnoughSuppliers" onchange="toggleDisqualify()"> 本项目不足3家
                                    </label>
                                    <p style="font-size:12px; color:#666; margin-top:5px;">* 请确认供应商数量是否符合要求</p>
                                </div>
                                
                                <div style="display:flex; gap:10px; margin-bottom:15px;">
                                    <button type="button" onclick="setAllQualification('pass')" style="padding:8px 15px; background:#2196F3; color:white; border:none; cursor:pointer;">
                                        全部通过
                                    </button>
                                    <button type="button" onclick="setAllQualification('fail')" style="padding:8px 15px; background:#f44336; color:white; border:none; cursor:pointer;">
                                        全部不通过
                                    </button>
                                </div>
                                
                                <div style="display:flex; gap:10px;margin-bottom:15px;">
                                    <button type="button" onclick="submitQualificationReview()" style="padding:10px 20px; background:#4CAF50; color:white; border:none; cursor:pointer; font-size:16px;">
                                        继续评审
                                    </button>
                                    <button type="button" id="disqualifyBtn" onclick="disqualifyProject()" style="padding:10px 20px; background:#f44336; color:white; border:none; cursor:not-allowed; font-size:16px; opacity:0.6;" disabled>
                                        废标
                                    </button>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button type="button" class="clarifybtn" onclick="showApplicationModal()" style="padding:10px 20px; background:#4CAF50; color:white; border:none; cursor:pointer; font-size:16px;">
                                        澄清管理
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="criteria-compliance" class="criteria-section">
                        <h3>实质性符合标准</h3>
                        <p>符合采购文件实质性要求：</p>
                        <ul>
                            <li>1. 技术参数完全响应</li>
                            <li>2. 交付时间满足要求</li>
                            <li>3. 质量保证措施完善</li>
                        </ul>
                        
                        <div style="margin-top:30px;">
                            <h4>供应商实质性符合评审</h4>
                            <form id="complianceEvaluationForm">
                                <!-- 供应商列表将通过JavaScript动态生成 -->
                                <div id="complianceSuppliersList"></div>
                                <script>
                                    // 动态生成符合性评审供应商列表
                                    function generateComplianceSuppliers() {
                                        const container = document.getElementById('complianceSuppliersList');
                                        container.innerHTML = '';
                                        
                                        // 获取资格评审通过的供应商
                                        const passedSuppliers = [];
                                        document.querySelectorAll('.supplier-name').forEach(supplierEl => {
                                            const id = supplierEl.dataset.id;
                                            const qualificationRadio = document.querySelector(`input[name="supplier${id}"]:checked`);
                                            if (qualificationRadio && qualificationRadio.value === 'pass') {
                                                passedSuppliers.push({
                                                    id: id,
                                                    name: supplierEl.dataset.name
                                                });
                                            }
                                        });
                                        var num=0;
                                        // 为每个供应商生成评审表单
                                        passedSuppliers.forEach(supplier => {
                                            const supplierDiv = document.createElement('div');
                                            supplierDiv.style.marginBottom = '20px';
                                            supplierDiv.style.padding = '15px';
                                            supplierDiv.style.border = '1px solid #eee';
                                            supplierDiv.style.borderRadius = '4px';
                                            supplierDiv.innerHTML = `
                                                <h5 class="supplier-name" data-id="${supplier.id}" data-name="${supplier.name}">供应商${++num}：${supplier.name}</h5>
                                                <div style="margin:10px 0;">
                                                    <label style="margin-right:15px;">
                                                        <input type="radio" name="supplier${supplier.id}_compliance" value="pass" required> 通过
                                                    </label>
                                                    <label>
                                                        <input type="radio" name="supplier${supplier.id}_compliance" value="fail"> 不通过
                                                    </label>
                                                </div>
                                                <div>
                                                    <label style="display:block; margin-bottom:5px;">评审说明：</label>
                                                    <textarea name="supplier${supplier.id}_compliance_comment" style="width:100%; height:60px; padding:8px; border:1px solid #ddd;box-sizing:border-box;"></textarea>
                                                </div>
                                            `;
                                            
                                            container.appendChild(supplierDiv);
                                        });
                                    }
                                    
                                    // 初始化事件监听
                                    document.addEventListener('DOMContentLoaded', function() {
                                        console.log('DOM加载完成，绑定事件监听');
                                        const complianceTab = document.getElementById('step-compliance');
                                        if (complianceTab) {
                                            complianceTab.addEventListener('click', function() {
                                                console.log('点击符合性评审标签');
                                                setTimeout(generateComplianceSuppliers, 50);
                                            });
                                        }
                                    });
                                </script>
                                
                                <!-- 是否满足3家 -->
                                <div style="margin:20px 0; padding:15px; background:#f9f9f9; border-radius:4px;">
                                    <label style="display:block; margin-bottom:10px;">
                                        <input type="checkbox" id="enoughCompliantSuppliers" onchange="toggleComplianceDisqualify()"> 本项目够3家
                                    </label>
                                    <label>
                                        <input type="checkbox" id="notEnoughCompliantSuppliers" onchange="toggleComplianceDisqualify()"> 本项目不足3家
                                    </label>
                                    <p style="font-size:12px; color:#666; margin-top:5px;">* 请确认供应商数量是否符合要求</p>
                                </div>
                                
                                <div style="display:flex; gap:10px; margin-bottom:15px;">
                                    <button type="button" onclick="setAllCompliance('pass')" style="padding:8px 15px; background:#2196F3; color:white; border:none; cursor:pointer;">
                                        全部通过
                                    </button>
                                    <button type="button" onclick="setAllCompliance('fail')" style="padding:8px 15px; background:#f44336; color:white; border:none; cursor:pointer;">
                                        全部不通过
                                    </button>
                                </div>
                                
                                <div style="display:flex; gap:10px;margin-bottom:15px;">
                                    <button type="button" onclick="submitComplianceReview()" style="padding:10px 20px; background:#4CAF50; color:white; border:none; cursor:pointer; font-size:16px;">
                                        继续评审
                                    </button>
                                    <button type="button" id="complianceDisqualifyBtn" onclick="disqualifyProject()" style="padding:10px 20px; background:#f44336; color:white; border:none; cursor:not-allowed; font-size:16px; opacity:0.6;" disabled>
                                        废标
                                    </button>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button type="button" class="clarifybtn" onclick="showApplicationModal()" style="padding:10px 20px; background:#4CAF50; color:white; border:none; cursor:pointer; font-size:16px;">
                                        澄清
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="criteria-scoring" class="criteria-section">
                        <h3>评分标准</h3>
                        <form id="scoringForm">
                            <!-- 动态生成通过符合性评审的供应商评分表 -->
                            <div id="qualifiedSuppliersScoring">
                                <!-- 将通过JavaScript动态生成 -->
                            </div>
                            
                            <!-- 提交分数按钮 -->
                            <div style="margin:20px 0; text-align:center;">
                                <button type="button" onclick="calculateScores()" style="padding:10px 20px; background:#2196F3; color:white; border:none; cursor:pointer;">
                                    提交分数
                                </button>
                            </div>
                            
                            <!-- 汇总显示 -->
                            <div id="resultScore" style="margin-bottom:20px; padding:15px; background:#f9f9f9; border-radius:4px;">
                                <h4>评分汇总</h4>
                                <table style="width:100%; border-collapse:collapse; margin-top:10px;" id="scoreSummaryTable">
                                    <thead>
                                        <tr>
                                            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">供应商</th>
                                            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">价格分</th>
                                            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">技术参数分</th>
                                            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">业绩分</th>
                                            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">方案分</th>
                                            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">总分</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 将通过JavaScript动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 确认提交按钮 -->
                            <div style="text-align:center;">
                                <button type="button" onclick="submitScoring()" style="padding:10px 30px; background:#4CAF50; color:white; border:none; cursor:pointer; font-size:16px;">
                                    确认提交
                                </button>
                                <button type="button" class="clarifybtn" onclick="showApplicationModal()" style="margin-left:10px;padding:10px 20px; background:#4CAF50; color:white; border:none; cursor:pointer; font-size:16px;">
                                    澄清
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="criteria-result" class="criteria-section">
                        <h3>评审结果</h3>
                        <p>综合评审结果将在此显示</p>
                        <div id="resultInfo"></div>
                        <div id="bidInfo"></div>
                        <div style="margin:20px 0; text-align:center;">
                            <button onclick="submitResult()" style="margin-top:20px;padding:10px 20px; background:#4CAF50; color:white; border:none; cursor:pointer; font-size:16px;"">
                                生成评审报告
                            </button>
                            <button type="button" class="clarifybtn" onclick="showApplicationModal()" style="margin-left:10px;padding:10px 20px; background:#4CAF50; color:white; border:none; cursor:pointer; font-size:16px;">
                                澄清
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 澄清管理弹窗 -->
    <div id="applicationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; width:900px; max-height:80vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="modalTitle">澄清管理</h3>
                <button onclick="closeModal()" style="padding:5px 10px; background:#f44336; color:white; border:none; cursor:pointer; font-size:20px;">×</button>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    供应商
                    <select id="enrollEndDateSearch" onchange="changeSelect(this.value)" class="gongyingshang" style="flex:1; padding: 5px; min-width: 200px;margin: 0 20px 0 5px;" >
                        <option value="">全部</option>
                    </select>
                </div>
                <button onclick="showModal()" style="padding:8px 20px; background:#2196F3; color:#fff; border:none;cursor: pointer;">发起澄清</button>
            </div>
            <table style="width:100%; border-collapse:collapse;">
                <thead id="pageThead">
                <tr style="background:#f5f5f5;">
                    <th style="padding:10px; border:1px solid #ddd;">供应商</th>
                    <th style="padding:10px; border:1px solid #ddd;width: 300px;">澄清原因</th>
                    <th style="padding:10px; border:1px solid #ddd;">响应截止时间</th>
                    <th style="padding:10px; border:1px solid #ddd;">响应状态</th>
                    <th style="padding:10px; border:1px solid #ddd;">操作</th>
                </tr>
                </thead>
                <tbody id="modalApplicationTable">
                <!-- 模拟数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
            <div id="pageInfo" style="margin-top:10px; text-align: center;"></div>
        </div>
    </div>
    <!-- 澄清弹窗 -->
    <div id="announcementModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; width:600px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>澄清内容</h3>
                <button onclick="closeModal2()" style="padding:5px 10px; background:#f44336; color:white; border:none; cursor:pointer; font-size:20px;">×</button>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">供应商<span style="color:red;">*</span></label>
                <select id="accountId" class="gongyingshang" style="width:100%; padding:8px; border:1px solid #ddd;box-sizing: border-box;" >
                    <option value="">请选择</option>
                </select>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">采购包号（采购包名称）<span style="color:red;">*</span></label>
                <input id="name" type="text" style="width:100%; padding:8px; border:1px solid #ddd;box-sizing: border-box;" required>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">澄清原因<span style="color:red;">*</span></label>
                <input id="reason" type="text" style="width:100%; padding:8px; border:1px solid #ddd;box-sizing: border-box;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">澄清要求<span style="color:red;">*</span></label>
                <textarea id="require" style="width:100%; height:150px; padding:8px; border:1px solid #ddd;box-sizing: border-box;"></textarea>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">响应截止时间<span style="color:red;">*</span></label>
                <input id="replyDate" type="datetime-local" style="width:100%; padding:8px; border:1px solid #ddd;box-sizing: border-box;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">澄清文件</label>
                <button onclick="showUploadDialog()" type="button" style="padding:8px 16px; background:#4CAF50; color:white; border:none; cursor:pointer; margin-top:10px;">上传文件</button>
                <div id="fileId">

                </div>
                <input data-file-id="" id="field" multiple type="file" style="width:100%; padding:8px; border:1px solid #ddd;display: none;">
            </div>

            <div style="text-align:center;">
                <button onclick="submit()" id="gonggao" style="padding:8px 20px; background:#4CAF50; color:white; border:none; cursor:pointer;">提交澄清</button>
            </div>
        </div>
    </div>
    <!-- InstanceEndEditable -->
    <script id="gysTemplate" type="text/x-handlebars-template">
        {{#each data}}
            <div style="margin-bottom:20px; padding:15px; border:1px solid #eee; border-radius:4px;">
                <h5 class="supplier-name" data-id="{{id}}" data-name="{{member.account.accountName}}">供应商{{#addition @index 1 }}{{/addition}}：{{member.account.accountName}}</h5>
                <div style="margin:10px 0;">
                    <label style="margin-right:15px;">
                        <input type="radio" name="supplier{{id}}" value="pass" required> 通过
                    </label>
                    <label>
                        <input type="radio" name="supplier{{id}}" value="fail"> 不通过
                    </label>
                </div>
                <div>
                    <label style="display:block; margin-bottom:5px;">评审说明：</label>
                    <textarea name="supplier1_comment{{id}}" style="width:100%; height:60px; padding:8px; border:1px solid #ddd;box-sizing:border-box;"></textarea>
                </div>
            </div>
        {{/each}}
    </script>
    <script id="projectTemplate" type="text/x-handlebars-template">
        {{#if list}}
        {{#each list}}
            <tr style="border: 1px solid rgb(221, 221, 221);">
                <td style="padding:10px;">{{associationName}}</td>
                {{#gt supplementaryContent.length 20 }}
                    <td style="margin:10px;overflow: hidden;-webkit-line-clamp: 1;-webkit-box-orient: vertical;text-overflow: ellipsis;display: -webkit-box;">{{supplementaryContent}}</td>
                {{else}}
                    <td style="padding:10px;">{{supplementaryContent}}</td>
                {{/gt}}
                <td style="padding:10px;">{{replyDate}}</td>
                <td style="padding:10px;">
                    {{#if replyContent}}
                        已响应
                    {{else}}
                        {{#gtNowDate replyDate}}
                            未响应
                        {{else}}
                            已超时
                        {{/gtNowDate}}
                    {{/if}}
                </td>
                <td style="padding:10px;">
                    <button onclick="deail('{{id}}')" style="padding:3px 8px; background:#4CAF50; color:#fff; border:none;cursor: pointer;">详情</button>
                </td>
            </tr>
        {{/each}}
        {{else}}
            <tr>
                <td colspan="5" style="padding:10px; border:1px solid #ddd;">没有澄清内容</td>
            </tr>
        {{/if}}
    </script>
    <script src="plugin/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="plugin/layer-animate/method.js"></script>
    <script src="plugin/handlebars-v4.0.11-dist/handlebars-v4.0.11.min.js" type="text/javascript"></script>
    <script src="plugin/handlebars-v4.0.11-dist/handlebars-ext.js" type="text/javascript"></script>
    <script src="plugin/naranja/naranja.js" type="text/javascript"></script>
    <script src="config/token.js" type="text/javascript"></script>
    <script>
        verifyLogin();
        var gongyingshang={};

        $(function() {
            // 初始化
            loadData();

            function loadData(){
                if(!new URLSearchParams(window.location.search).get("id")) return;
                $.ajax({
                    url: "/projectRegister/getProjectSuccess/"+new URLSearchParams(window.location.search).get("id"),
                    type: "GET",
                    contentType: "application/json",
                    success:function(e) {
                        if(e.status == 200){
                            if(e.data.length==0){
                                $("#notEnoughSuppliers").attr("checked","checked");
                                initPDFViewer(-1);
                                alert("没有供应商参与报名，请选择废标操作!");
                                disqualifyBtn.disabled = false;
                                disqualifyBtn.style.opacity = '1';
                                disqualifyBtn.style.cursor = 'pointer';
                                return;
                            }
                            localStorage.setItem('data'+getMember().id, JSON.stringify(e)); //缓存数据 方便后面查询
                            var companies = [];
                            for(var i=0;i<e.data.length;i++){
                                var fileIds = [];
                                var bidDocumentIds = e.data[i].bidDocumentIds;
                                if(!bidDocumentIds){
                                    bidDocumentIds = [];
                                }
                                for(var j=0;j<bidDocumentIds.length;j++){
                                    fileIds.push(bidDocumentIds[j].name+"（"+bidDocumentIds[j].fileSize+"）_"+bidDocumentIds[j].id);
                                }
                                supplierFiles[i+1] = fileIds;
                                var option = document.createElement("option");
                                option.setAttribute("value",i+1);
                                option.innerText=`供应商${i+1}：${e.data[i].member.account.accountName}`;
                                document.getElementById('supplierSelect').appendChild(option)
                                companies.push({id:e.data[i].member.account.id,projectId:e.data[i].project.id,name: e.data[i].member.account.accountName, sort:(i+1),state:"未发起响应"})
                                gongyingshang[e.data[i].member.account.id]=e.data[i].member.account.accountName;
                            }

                            Object.keys(gongyingshang).forEach(key => {
                                $(".gongyingshang").append("<option value='"+key+"'>"+gongyingshang[key]+"</option>")
                            });
                            announcementModal = $("#announcementModal").html();

                            var newTemplate = Handlebars.compile($("#gysTemplate").html())(e);
                            $("div#gys").html(newTemplate);
                            // 最后初始化PDF查看器
                            initPDFViewer(-1);
                            initData();
                            if(e.data.length>0){
                                commitment(e.data[0].project.projectName,e.data[0].project.projectCode);
                            }
                            // responseInfo();
                        }else{
                            alert("获取投标方失败："+e.message);
                        }
                    }
                });
            }

            function initData(){
                var member = {'id':getMember().id};
                var data = {'projectId':new URLSearchParams(window.location.search).get("id"),'reviewType':1,'member':member};
                $.ajax({
                    url: "/evaluation/select",
                    type: "POST",
                    data: JSON.stringify(data),
                    contentType: "application/json",
                    success:function(e) {
                        if(e.status == 200){
                            for(var i=0;i<e.data.length;i++){
                                var data = e.data[i];
                                $("input[name='supplier"+data.projectRegisterId+"'][value="+(data.isPass==0?'pass':'fail')+"]").prop("checked",true);
                                $("textarea[name='supplier1_comment"+data.projectRegisterId+"']").val(data.reviewDescription);
                            }
                        }else{
                            alert("获取资格评审标准失败："+e.message);
                        }
                    }
                });
            }
        });
        function submitResult(){
            // 将页面保存
            var printContent = "";
            for(var i=0;i<printContents.length;i++){
                printContent+=printContents[i];
            }
            var project={"id":new URLSearchParams(window.location.search).get("id"),"isPass":0};
            var data = {"project":project,"state":1,"resultHtml":printHTML(printContent)};
            $.ajax({
                url: "/resultReport/createOrUpdate",
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json",
                success:function(e) {
                    if(e.status == 200){
                        alert("评审报告生成成功！");
                        location.href = "/Bid-e-r.html?id="+new URLSearchParams(window.location.search).get("id");
                    }else{
                        alert('评审报告生成失败：'+e.message);
                    }
                }
            });

        }

        // 承诺书
        function commitment(name,code){
            var obj={
                type:"layer-fadeIn",
                title:"承诺书",
                close:"false",
                content:"<div style='text-align: left;line-height: 1.5;font-family:Arial; font-size:13px;'><div>四川中天阳光招标代理有限公司:</div>" +
                "<div>我以（专家、采购人代表）身份参与"+name+"（采购项目编号："+code+"）评审活动。我确认：自己身体健康，无重大疾病，并具备有关政府采购的政策水平和对本项目的业务评审能力。</div>" +
                "<div>我郑重承诺：评审中严格执行《中华人民共和国政府采购法》及相关法规规定，履行以下职责与义务、遵守以下纪律：</div>" +
                "<div>一、履行以下职责：</div>" +
                "<div>（一）熟悉和理解采购文件（包括招标文件、谈判文件、询价通知书、磋商文件、单一来源采购文件等，下同）；</div>" +
                "<div>（二）审查供应商投标（响应）文件等是否满足采购文件要求，并作出评价；</div>" +
                "<div>（三）对响应文件进行比较和评价；</div>" +
                "<div>（四）根据需要要求采购组织单位对采购文件作出解释；根据需要要求供应商对投标（响应）文件有关事项作出澄清、说明或者更正；</div>" +
                "<div>（五）推荐中标（成交）候选供应商，或者受采购人委托确定中标（成交）供应商；</div>" +
                "<div>（六）起草评审报告并进行签署；</div>" +
                "<div>（七）向采购人、代理机构或者有关部门报告评审中发现的违法行为；</div>" +
                "<div>（八）法律、法规和规章规定的其他职责。</div>" +
                "<div>二、履行下列义务:</div>" +
                "<div>（一）遵守评审工作纪律;</div>" +
                "<div>（二）按照客观、公正、审慎的原则，根据采购文件规定的评审程序、评审方法和评审标准进行独立评审;</div>" +
                "<div>（三）不泄露评审文件、评审情况和在评审过程中获悉的商业秘密;</div>" +
                "<div>（四）及时向监督管理部门报告评审过程中的违法违执情况，包括采购人、代理机构向评审专家作出倾向性、误导性的解释或者说明情况，供应商行贿、提供虚假材料或者串通情况，其他丰法于预评审情况等</div>" +
                "<div>（五）发现采购文件内容违反国家有关强制性规定或者存在歧义、重大缺路导致评审工作无法讲行时，信止评审并通讨交易系统向代理机构书面说明情况，说明停止评南的情开幼具体理中</div>" +
                "<div>（六）配合答复处理供应商的询问、质疑和投诉等事项;</div>" +
                "<div>（七）法律、法规和规章规定的其他义务</div>" +
                "<div>三、遵守下列工作纪律</div>" +
                "<div>（一）遵行《中华人民共和国政府采购法》第十二条和《中华人民共和国政府采购法实施条例》第九条及财政部关于回避的规定</div>" +
                "<div>（二）评审前，应当将通讯工具或者相关电子设备交由代理机构统一保管。</div>" +
                "<div>（三）评审过程中，不与外界联系，因发生不可预见情况，确实需要与外界联系的，在监督人员监督之下办理。</div>" +
                "<div>（四）评审过程中，不干成省饰工评审工作、不发表倾向性、引导性意见，不修改或细化采购文件确定的评种巷房、许审方法、许南因素材车南标巷，不海受片立南主动是出的经青酶释，不化自乐响人代表的德见，不法商评分，不违反规定的译南格式饰评分和出与评南意见，不的自己的许审意见盗字样议。</div>" +
                "<div>（五）在评审过程中和评审结束后，不得记录、复制或带走任何评审资料，除因配合答复处理供应商的询问、质疑和投诉等事项外，不得向外界透露评审内容。</div>" +
                "<div>（六）服从评审现场代理机构的现场秩序管理，接受评审现场监督人员的合法监督</div>" +
                "<div>（七）遵守有关廉洁自律规定，不得私下接触供应商，不得收受供应商及有关业务单位和个人的财物或好处，不得接受采购人、代理机构的请托。</div>" +
                "</div>",
                btn:["不同意","同意"]
            };
            method.msg_layer(obj);
        }

        $("body").delegate(".layer-cancel","click",function(){
            window.history.back();
        });
        $("body").delegate(".layer-commit2","click",function(){
            var id = $("input[name='expert']:checked").attr("data-id");
            var num = $("input[name='expert']:checked").attr("data-num");
            var memberId = $("input[name='expert']:checked").attr("data-memberId");
            if(id){
                $.ajax({
                    url: "/review/voteLeader?id="+id+"&memberId="+memberId+"&num="+num,
                    type: "POST",
                    contentType: "application/json",
                    success: function (e) {
                        if(e.status == 200){
                            localStorage.setItem('vote'+new URLSearchParams(window.location.search).get("id")+getMember().id,getMember().id);
                            alert("投票成功!");
                            method.msg_close();
                            getLeader(id);
                        }else{
                            alert(e.message);
                        }
                    }
                });

            }else{
                alert("请选择投票！")
            }
        });
        var memberMap = {};
        $("body").delegate(".layer-commit","click",function(){
            // 防止重复投票
            if(localStorage.getItem('vote'+new URLSearchParams(window.location.search).get("id")+getMember().id)){
                method.msg_close();
                return;
            }
            $.ajax({
                url: "/expertInfo/get/" + new URLSearchParams(window.location.search).get("id"),
                type: "GET",
                contentType: "application/json",
                success: function (e) {
                    if(e.status == 200){
                        // 是否有专家组长
                        if(e.data.expertLeader){
                            method.msg_close();
                            return;
                        }
                        memberMap = {};
                        var content = '';
                        for(var i=0;i<e.data.selectExpert.length;i++){
                            var selectExpert = e.data.selectExpert[i];
                            var memberId = selectExpert.member.id;
                            var name = selectExpert.member.name;
                            content+='<div><input type="radio" data-memberId="'+memberId+'" data-num="'+e.data.selectExpert.length+'" data-id="'+e.data.id+'" name="expert" style="cursor: pointer;" /><span style="padding-left:5px;">'+name+'</span></div>';
                            memberMap[memberId] = name;
                        }

                        var obj={
                            type:"layer-fadeIn",
                            title:"请投票选出组长&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",
                            close:"false",
                            content:"<div style='text-align: left;line-height: 2.5;font-family:Arial;'>"+content+"</div>" ,
                            btn:["0","0","投票"]
                        };
                        method.msg_layer(obj);
                    }else{
                        alert(e.message);
                        window.history.back();
                    }
                }
            });
        });

        var getLeaderInterval;
        function getLeader(id) {
            getLeaderInterval = setInterval(function () {
                $.ajax({
                    url: "/review/getLeader/" +id,
                    type: "GET",
                    contentType: "application/json",
                    success: function (e) {
                        if(e.status == 200){
                            localStorage.removeItem('vote'+new URLSearchParams(window.location.search).get("id")+getMember().id);
                            var memberId = e.data;
                            alert("投票结束，专家组长："+memberMap[memberId]);
                            clearInterval(getLeaderInterval);
                        }
                    }
                });
            },1000)
        }

        function initPageShow(data){
            clarifyData(data);
        }

        var dataInfo = {};
        function clarifyData(accountId){
            var page = "?size=5";
            var pageInfo = localStorage.getItem('page');
            if(pageInfo){
                page+="&page="+pageInfo;
            }
            var data ={"type":"1"};
            if(accountId){
                data["associationId"]=accountId;
            }
            $.ajax({
                url: "/tendereeInfo/page"+page,
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json",
                success:function(e) {
                    if(e.status == 200){
                        dataInfo = {};
                        for(var i=0;i<e.data.list.length;i++){
                            e.data.list[i].associationName = gongyingshang[e.data.list[i].associationId];
                            dataInfo[e.data.list[i].id]=e.data.list[i];
                        }
                        $("#modalApplicationTable").html(Handlebars.compile($("#projectTemplate").html())(e.data));
                        pageButton(e.data);
                    }else{
                        alert("查询澄清列表失败："+e.message);
                    }
                }
            });
        }

        // 显示弹窗
        function showApplicationModal() {
            clarifyData("");
            document.getElementById('applicationModal').style.display = 'block';
        }
        // 关闭弹窗
        function closeModal() {
            messageShow = true;
            document.getElementById('applicationModal').style.display = 'none';
        }
        var messageShow = true;
        // 消息弹框
        function narn (type) {
            messageShow = false;
            naranja()[type]({
                title: '消息提示',
                isHideClose: true,
                text: '供应商发起了澄清消息响应，请及时查看！',
                timeout: 'keep',
                buttons: [{
                    text: '查看',
                    click: function (e) {
                        showApplicationModal();
                        e.closeNotification();
                    }
                },{
                    text: '关闭',
                    click: function (e) {
                        e.closeNotification();
                        messageShow = true;
                    }
                }]
            })
        }
        // 显示弹窗
        function showModal() {
            $("#announcementModal").show();
        }

        function closeModal2(){
            $("#announcementModal").hide();
        }

        function showUploadDialog() {
            document.getElementById('field').click();
        }

        $("body").on('change','#field', function () {
            if(this.files.length==0){
                return;
            }
            var fileId = uploadFile(this.files);
            $("#field").attr("data-file-id",fileId);

            var fileName = "";
            var fileIds = fileId.split(",");
            for(var i=0;i<this.files.length;i++){
                fileName+="<p><a style=\"padding:5px 10px; background:#2196F3; color:white; border:none; cursor:pointer; text-decoration:none;font-size: 13px;\" target=\"_blank\" href='/file/preview/"+fileIds[i]+"'>"+this.files[i].name+"（"+convertSize(this.files[i].size)+"）</a></p>";
            }
            $("#fileId").html(fileName);
        });

        var announcementModal ;
        function submit(){
            $("#gonggao").attr("disabled","true");
            var accountId = $("#accountId").find("option:selected").val();
            var replyDate = $("#replyDate").val();
            var name = $("#name").val();
            var reason = $("#reason").val();
            var require = $("#require").val();
            var fileId = $("#field").attr("data-file-id");
            var content = "<table style='white-space: pre-wrap;font-family:Arial; font-size:14px; line-height:2;text-align: left;'>";
            content += "<tr><td style='text-align: right;font-weight: bolder;vertical-align: top;width: 180px;'>供应商：</td><td style='text-align: left;'><div style='max-height: 60px;overflow: auto;'>"+gongyingshang[accountId]+"</div></td></tr>";
            content += "<tr><td style='text-align: right;font-weight: bolder;vertical-align: top;width: 180px;'>采购包号（采购包名称）：</td><td style='text-align: left;'><div style='max-height: 60px;overflow: auto;'>"+name+"</div></td></tr>";
            content += "<tr><td style='text-align: right;font-weight: bolder;vertical-align: top;width: 180px;'>澄清原因：</td><td style='text-align: left;'><div style='max-height: 60px;overflow: auto;'>"+reason+"</div></td></tr>";
            content += "<tr><td style='text-align: right;font-weight: bolder;vertical-align: top;width: 180px;'>澄清要求：</td><td style='text-align: left;width:76%;'><div style='max-height: 200px;overflow: auto;'>"+require+"<div></div></td></tr>";
            content += "<tr><td style='text-align: right;font-weight: bolder;vertical-align: top;width: 180px;'>响应截止时间：</td><td style='text-align: left;'><div style='max-height: 60px;overflow: auto;'>"+new Date(replyDate).toLocaleString().replaceAll("/","-")+"</div></td></tr>";
            content += "<tr><td style='text-align: right;font-weight: bolder;vertical-align: top;width: 180px;'><p>响应文件原文：</p></td><td style='text-align: left;'><div style='max-height: 150px;overflow: auto;'>"+$("#fileId").html()+"</td></div></tr>";
            content += "</table>";

            if(!name || !reason || !require || !accountId || !replyDate) {
                alert("请填写带 * 字段为必填项！");
                $("#gonggao").removeAttr("disabled");
                return;
            }
            var now = new Date().getTime();
            var replyDateTime = new Date(replyDate).getTime();
            if(replyDateTime<=now){
                alert("响应截止时间 不能早于或等于当前时间！");
                $("#gonggao").removeAttr("disabled");
                return;
            }
            var data = {"projectId":new URLSearchParams(window.location.search).get("id"),
                "associationId":accountId,
                "title":name,
                "supplementaryContent":reason,
                "content":content,
                "isPublic":1,"type":1,
                "tendereeInformField":fileId,
                "replyDate":new Date(replyDate).toLocaleString().replaceAll("/","-")};
            $.ajax({
                url: "/tendereeInfo/create",
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json",
                success:function(e) {
                    if(e.status == 200){
                        clarifyData(localStorage.getItem('data'));
                        alert("提交成功！");
                        closeModal2();
                        $("#announcementModal").html(announcementModal); // 清空数据
                    }else{
                        $("#gonggao").removeAttr("disabled");
                        alert("提交澄清内容失败："+e.message);
                    }
                }
            });
        }

        function deail(id){
            var obj={
                type:"layer-fadeIn",
                title:"澄清内容",
                content:dataInfo[id].content
            };
            method.msg_layer(obj);
        }

        // 响应状态
        // function responseInfo(){
        //     $.ajax({
        //         url: "/resultReport/getState/"+new URLSearchParams(window.location.search).get("id"),
        //         type: "GET",
        //         contentType: "application/json",
        //         success:function(e) {
        //             if(e.status == 200){
        //                 var isShow = false;
        //                 Object.keys(e.data).forEach(key => {
        //                     var datas = key.split("|");
        //                     if(e.data[key] == "0"){
        //                         $(".clarifyState[data-id="+datas[1]+"]").html("发起响应")
        //                         isShow=true;
        //                     }else{
        //                         $(".clarifyState[data-id="+datas[1]+"]").html("已响应")
        //                     }
        //                 });
        //                 if(isShow){
        //                     if(messageShow){
        //                         narn('log');
        //                     }
        //                 }
        //                 setTimeout(responseInfo,10000);
        //             }
        //         }
        //     });
        // }

    </script>
</body>
<!-- InstanceEnd --></html>
