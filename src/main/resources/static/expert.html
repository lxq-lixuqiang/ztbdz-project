<!doctype html>
<html><!-- InstanceBegin template="/Templates/001.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
<meta charset="utf-8">
<!-- InstanceBeginEditable name="doctitle" -->
<title>专家管理页面</title>
<!-- InstanceEndEditable -->
<!-- InstanceBeginEditable name="head" -->
<script src="/js/db-connection.js"></script>
<style>
    .container {
        display: flex;
        width: 100%;
        height: 100%;
    }
    .nav-menu {
        width: 140px;
        background: #f5f5f5;
        padding: 10px;
    }
    .nav-item {
        padding: 8px;
        cursor: pointer;
        border-bottom: 1px solid #ddd;
    }
    .nav-submenu {
        display: none;
        padding-left: 9px;
    }
    .nav-submenu-item {
        padding: 5px;
        cursor: pointer;
    }
    .content-area {
        flex: 1;
        padding: 20px;
    }
    .tab-header {
        display: flex;
        border-bottom: 1px solid #ddd;
    }
    .tab-item {
        padding: 10px 20px;
        cursor: pointer;
        border: 1px solid #ddd;
        margin-right: 5px;
        background: #f5f5f5;
    }
    .tab-item.active {
        background: #fff;
        border-bottom: 1px solid #fff;
    }
    .tab-content {
        display: none;
        padding: 20px;
        border: 1px solid #ddd;
        border-top: none;
    }
    .tab-content.active {
        display: block;
    }
</style>
<script>
    function showTab(tabId) {
        // 隐藏所有标签内容
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        // 取消所有标签项的active类
        document.querySelectorAll('.tab-item').forEach(item => {
            item.classList.remove('active');
        });
        // 显示选中的标签内容
        const content = document.getElementById(tabId);
        content.classList.add('active');
        // 更新内容区域提示信息
        if(tabId === 'application') {
            content.textContent = '这里是项目报名信息';
        }
        // 激活对应的标签项
        document.querySelector(`.tab-item[data-tab="${tabId}"]`).classList.add('active');
    }

    // 为所有标签项添加点击事件
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.tab-item').forEach(item => {
            item.addEventListener('click', function() {
                showTab(this.dataset.tab);
            });
        });
    });

    function showAffairTabs() {
        // 显示事务相关标签页
        document.querySelectorAll('.tab-item').forEach(item => {
            const tabId = item.dataset.tab;
            item.style.display = (tabId === 'overview') ? 'block' : 'none';
        });
        showTab('overview');
    }

    function showProjectTabs() {
        // 显示项目相关标签页
        document.querySelectorAll('.tab-item').forEach(item => {
            const tabId = item.dataset.tab;
            item.style.display = (tabId === 'project1' || tabId === 'project2' || tabId === 'project3') ? 'block' : 'none';
        });
        showTab('project1');
    }

    // 初始化显示事务相关标签页
    window.onload = function() {
        showAffairTabs();
    };
</script>
<!-- InstanceEndEditable -->
</head>

<body>
    <!-- 不可编辑的顶部区域 -->
    <div style="width:1040px; height:120px; background:#f0f0f0; position:relative; display:flex; justify-content:space-between; align-items:center; padding:0 50px;">
        <div style="font-size:28px; font-weight:bold;">中天阳光AI智能化评标系统</div>
        <div style="display:flex; gap:30px;">
            <a href="index.html" style="text-decoration:none; color:#333;">返回首页</a>
            <a href="login.html" style="text-decoration:none; color:#333;">登录</a>
            <a href="login-out.html" style="text-decoration:none; color:#333;">退出</a>
        </div>
    </div>
    
    <!-- 可编辑的主要内容区域 -->
    <!-- InstanceBeginEditable name="content" -->
    <div style="width:1040px; min-height:calc(100vh - 120px);">
        <div class="container">
            <div class="nav-menu">
                <div class="nav-item" onclick="showAffairTabs()">我的事务</div>
                <div class="nav-item" onclick="showProjectTabs()">我的项目</div>
            </div>
            <div class="content-area">
                <div class="tab-header">
                    <div class="tab-item active" data-tab="overview">综合</div>
                    <div class="tab-item" data-tab="project1">可评审项目</div>
                    <div class="tab-item" data-tab="project2">正在评审项目</div>
                    <div class="tab-item" data-tab="project3">评审结束项目</div>
                </div>
                <div class="tab-content active" id="overview">这里是综合信息概览</div>
                <div class="tab-content" id="project1">
                    <h3>可评审项目列表</h3>
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f5f5f5;">
                                <th style="padding:10px; border:1px solid #ddd;">选择</th>
                                <th style="padding:10px; border:1px solid #ddd;">项目名称</th>
                                <th style="padding:10px; border:1px solid #ddd;">截止时间</th>
                                <th style="padding:10px; border:1px solid #ddd;">操作</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
                <div class="tab-content" id="project2">
                    <h3>正在评审项目</h3>
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f5f5f5;">
                                <th style="padding:10px; border:1px solid #ddd;">项目名称</th>
                                <th style="padding:10px; border:1px solid #ddd;">开始时间</th>
                                <th style="padding:10px; border:1px solid #ddd;">进度</th>
                                <th style="padding:10px; border:1px solid #ddd;">操作</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
                <div class="tab-content" id="project3">
                    <h3>评审结束项目</h3>
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f5f5f5;">
                                <th style="padding:10px; border:1px solid #ddd;">项目名称</th>
                                <th style="padding:10px; border:1px solid #ddd;">评审时间</th>
                                <th style="padding:10px; border:1px solid #ddd;">评审结果</th>
                                <th style="padding:10px; border:1px solid #ddd;">操作</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script id="project1Template" type="text/x-handlebars-template">
        {{#if list}}
        {{#each list}}
        <tr>
            <td style="padding:10px; border:1px solid #ddd; text-align:center;">
                <input data-id="{{id}}" type="checkbox">
            </td>
            <td style="padding:10px; border:1px solid #ddd;">{{projectName}}</td>
            <td style="padding:10px; border:1px solid #ddd;">{{enrollEndDate}}</td>
            <td style="padding:10px; border:1px solid #ddd;">
                {{#if isAdmin}}
                    <a href="Bid evaluation.html?id={{id}}">
                        <button style="padding:5px 10px; background:#4CAF50; color:white; border:none; cursor:pointer;">进入评审</button>
                    </a>
                {{else}}
                    <a href="Bid evaluation.html?id={{id}}">
                        <button style="padding:5px 10px; background:#4CAF50; color:white; border:none; cursor:pointer;">进入评审</button>
                    </a>
                    <a href="result.html?id={{id}}">
                        <button style="padding:5px 10px; background:#2196F3; color:white; border:none; cursor:pointer;">查看评分汇总</button>
                    </a>
                {{/if}}
            </td>
        </tr>
        {{/each}}
        {{else}}
        <tr>
            <td colspan="5" style="padding:10px; border:1px solid #ddd;">没有可评审项目列表</td>
        </tr>
        {{/if}}
    </script>
    <script id="project2Template" type="text/x-handlebars-template">
        {{#if list}}
        {{#each list}}
        <tr>
            <td style="padding:10px; border:1px solid #ddd;">{{projectName}}</td>
            <td style="padding:10px; border:1px solid #ddd;">{{bidOpeningTime}}</td>
            <td style="padding:10px; border:1px solid #ddd;">{{reviewProgress}}%</td>
            <td style="padding:10px; border:1px solid #ddd;">
                {{#if isAdmin}}
                    <a href="Bid evaluation.html?id={{id}}">
                        <button style="padding:5px 10px; background:#2196F3; color:white; border:none; cursor:pointer;">继续评审</button>
                    </a>
                {{else}}
                    <a href="result.html?id={{id}}">
                        <button style="padding:5px 10px; background:#2196F3; color:white; border:none; cursor:pointer;">查看评分汇总</button>
                    </a>
                {{/if}}
            </td>
        </tr>
        {{/each}}
        {{else}}
        <tr>
            <td colspan="5" style="padding:10px; border:1px solid #ddd;">没有正在评审项目</td>
        </tr>
        {{/if}}
    </script>
    <script id="project3Template" type="text/x-handlebars-template">
        {{#if list}}
        {{#each list}}
        <tr>
            <td style="padding:10px; border:1px solid #ddd;">{{projectName}}</td>
            <td style="padding:10px; border:1px solid #ddd;">{{bidOpeningTime}}</td>
            <td style="padding:10px; border:1px solid #ddd;">{{#eq isPass null }}未公布{{/eq}}{{#eq isPass 0}}通过{{/eq}}{{#eq isPass 1}}废标{{/eq}}</td>
            <td style="padding:10px; border:1px solid #ddd;">
                {{#eq isPass 0}}
                <a href="result.html?id={{id}}">
                    <button style="padding:5px 10px; background:#2196F3; color:white; border:none; cursor:pointer;">查看评分汇总</button>
                </a>
                {{/eq}}
            </td>
        </tr>
        {{/each}}
        {{else}}
        <tr>
            <td colspan="5" style="padding:10px; border:1px solid #ddd;">没有评审结束项目</td>
        </tr>
        {{/if}}
    </script>
    <!-- InstanceEndEditable -->
    <script src="plugin/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="plugin/handlebars-v4.0.11-dist/handlebars-v4.0.11.min.js" type="text/javascript"></script>
    <script src="plugin/handlebars-v4.0.11-dist/handlebars-ext.js" type="text/javascript"></script>
    <script src="config/token.js" type="text/javascript"></script>
    <script>
        $(function() {
            // 初始化
            verifyLogin();
            var isAdmin = false;
            getIsAdmin();
            reviewProject($("#project1 tbody"),Handlebars.compile($("#project1Template").html()));

            $("body").on("click", "div[data-tab=project1]", function() {
                reviewProject($("#project1 tbody"),Handlebars.compile($("#project1Template").html()));
            });
            $("body").on("click", "div[data-tab=project2]", function() {
                runReviewProjectInit($("#project2 tbody"),Handlebars.compile($("#project2Template").html()));
            });
            $("body").on("click", "div[data-tab=project3]", function() {
                availableInit(3,$("#project3 tbody"),Handlebars.compile($("#project3Template").html()));
            });
            function availableInit(state,tbody,template){
                var url = "/project/expertList";
                if(isAdmin){
                    url = "/project/list";
                }
                $.ajax({
                    url: url,
                    type: "POST",
                    data: JSON.stringify({"state":state}),
                    contentType: "application/json",
                    success:function(e) {
                        if(e.status == 200){
                            e.data.isAdmit = isAdmin;
                            var newTemplate = template(e.data);
                            tbody.html(newTemplate);
                        }else{
                            alert("获取项目列表失败："+e.message);
                        }
                    }
                });
            }
            function runReviewProjectInit(tbody,template){
                var url = "/project/expertRunReviewProject";
                if(isAdmin){
                    url = "/project/runReviewProject";
                }
                $.ajax({
                    url: url,
                    type: "POST",
                    contentType: "application/json",
                    success:function(e) {
                        if(e.status == 200){
                            e.data.isAdmit = isAdmin;
                            var newTemplate = template(e.data);
                            tbody.html(newTemplate);
                        }else{
                            alert("获取项目列表失败："+e.message);
                        }
                    }
                });
            }

            function reviewProject(tbody,template){
                var url = "/project/expertReviewProject";
                if(isAdmin){
                    url = "/project/reviewProject";
                }
                $.ajax({
                    url: url,
                    type: "POST",
                    contentType: "application/json",
                    success:function(e) {
                        if(e.status == 200){
                            e.data.isAdmit = isAdmin;
                            var newTemplate = template(e.data);
                            tbody.html(newTemplate);
                        }else{
                            alert("获取可评审项目列表失败："+e.message);
                        }
                    }
                });
            }

            function getIsAdmin(){
                $.ajax({
                    url: "/expertInfo/getMemberInfo/"+getMember().id,
                    type: "GET",
                    async: false,
                    contentType: "application/json",
                    success:function(e) {
                        if(e.status == 200){
                            if(e.data.isAdmin==1) {
                                isAdmin = true;
                            }
                        }else{
                            alert("查询专家信息失败："+e.message);
                        }
                    }
                });
            }

        });
    </script>
</body>
<!-- InstanceEnd --></html>
